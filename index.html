<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meditation — Month Tracker</title>
  <meta name="color-scheme" content="dark">
  <style>
    :root{
      --bg:#181a1f;
      --panel:#1c1f26;
      --ink:#e8eaee;
      --muted:#a8adb7;
      --ring:#2b3040;
      --ok:#7ce0b6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 20% -10%, #212532 0, transparent 60%),
        var(--bg);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      font:16px/1.65 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      letter-spacing:.2px;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      padding-bottom: env(safe-area-inset-bottom); /* iOS safe area */
    }

    /* Top header row */
    .top{
      display:flex;align-items:flex-end;justify-content:space-between;
      max-width:980px;margin:28px auto 0;padding:0 16px;
    }
    h1{
      margin:0;
      font-weight:750;
      font-size: clamp(3.25rem, 7.5vw, 6.25rem); /* slightly larger */
      line-height:1.03;
      letter-spacing:.2px;
    }
    .streak{font-size:1rem;color:var(--muted);padding-bottom:10px}
    .streak strong{color:var(--ink)}

    /* Spacer creates breathing room; calendar sits lower */
    .spacer{flex:1}

    /* Calendar section near the bottom, but never too low */
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:0 16px;
      /* keep it comfortably above the bottom UI (iOS/Android bars) */
      margin-bottom:clamp(64px, 8vh, 140px);
    }

    .monthbar{display:flex;gap:12px;align-items:center;margin:0 0 16px}
    .monthtitle{font-size:1.28rem;font-weight:650;letter-spacing:.2px}
    .navbtn{
      background:transparent;border:none;color:var(--ink);cursor:pointer;
      font-size:1.15rem;line-height:1;border-radius:8px;padding:6px 8px;opacity:.8;
    }
    .navbtn:hover{opacity:1}

    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:22px}
    .spacerCell{height:0}
    .day{
      position:relative;display:flex;align-items:center;justify-content:center;
      height:74px;background:transparent;border:none;color:inherit;cursor:pointer;border-radius:14px;
    }
    .day:focus-visible{outline:2px solid var(--ring);outline-offset:3px}
    .num{font-size:18px;padding:10px 14px;border-radius:12px;transition:background .12s ease, box-shadow .12s ease}
    .day:hover .num{background:rgba(255,255,255,.04);box-shadow:0 0 0 1px var(--ring) inset,0 10px 30px rgba(0,0,0,.25)}

    /* dotted ring for today (visible with or without 'done') */
    .day.today::before{
      content:""; position:absolute; inset:10px;
      border:2px dotted rgba(232,234,238,.6);
      border-radius:14px; pointer-events:none;
    }

    /* semi-transparent check when done */
    .day.done::after{
      content:"✓"; position:absolute; right:10px; bottom:8px;
      font-weight:800; opacity:.5; color:var(--ok); font-size:18px; pointer-events:none;
    }

    /* Note preview popover on hover (if exists) */
    .note-tip{
      display:none; position:absolute; left:50%; transform:translateX(-50%);
      bottom:86px; width:min(320px,80vw); background:var(--panel);
      border:1px solid var(--ring); border-radius:12px; padding:10px 12px;
      color:var(--ink); text-align:left; box-shadow:0 20px 50px rgba(0,0,0,.35); z-index:5;
    }
    .note-tip .title{font-weight:650;font-size:.95rem;margin-bottom:4px}
    .note-tip .meta{color:var(--muted);font-size:.8rem}
    .day.hasnote:hover .note-tip{display:block}

    /* Modal */
    dialog{border:none;border-radius:16px;background:var(--panel);color:var(--ink);width:min(720px,calc(100% - 24px));padding:0}
    .modal-head{padding:14px 16px;border-bottom:1px solid var(--ring);display:flex;justify-content:space-between;align-items:center}
    .modal-head .titles{display:flex;flex-direction:column;gap:2px}
    .modal-head .date{color:var(--muted);font-size:.92rem}
    .modal-body{padding:16px;display:grid;gap:12px}
    .controls{display:flex;gap:10px;align-items:center}
    .btn{background:transparent;border:1px solid var(--ring);color:var(--ink);border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:hover{border-color:#3a4150}
    textarea{width:100%;min-height:220px;resize:vertical;background:#151821;color:var(--ink);border:1px solid var(--ring);border-radius:12px;padding:12px;font:15px/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .meta{color:var(--muted);font-size:.85rem}

    @media (max-width:600px){
      .calendar{gap:14px}
      .day{height:58px}
      .num{font-size:16px}
      .wrap{margin-bottom:clamp(56px, 10vh, 140px)} /* on small screens, keep it a bit higher */
    }
  </style>
</head>
<body>
  <div class="top">
    <h1>Meditation</h1>
    <div class="streak">Streak: <strong id="streakNum">0</strong></div>
  </div>

  <div class="spacer" aria-hidden="true"></div>

  <div class="wrap">
    <div class="monthbar">
      <button class="navbtn" id="prev" aria-label="Previous month">←</button>
      <div class="monthtitle" id="monthtitle">Oct 2025</div>
      <button class="navbtn" id="next" aria-label="Next month">→</button>
    </div>
    <div id="cal" class="calendar" aria-live="polite"></div>
  </div>

  <dialog id="modal">
    <div class="modal-head">
      <div class="titles">
        <div id="m-title" style="font-weight:700; font-size:1.05rem">Meditation Note</div>
        <div class="date" id="m-date"></div>
      </div>
      <div class="controls">
        <button class="btn" id="toggleDone">Mark Done</button>
        <button class="btn" id="closeModal">Close</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="meta" id="meta"></div>
      <textarea id="noteText" placeholder="Write your note for this day..."></textarea>
      <div class="controls">
        <button class="btn" id="saveNote">Save</button>
      </div>
    </div>
  </dialog>

  <script>
    const DONE_KEY = "meditation_done_v4";
    const NOTE_KEY = "meditation_notes_v4";
    const doneMap = loadJSON(DONE_KEY, {});
    const notesMap = loadJSON(NOTE_KEY, {});

    const cal = document.getElementById('cal');
    const monthTitle = document.getElementById('monthtitle');
    const streakNum = document.getElementById('streakNum');

    let current = new Date(); current.setDate(1);
    document.getElementById('prev').onclick = ()=>{ current.setMonth(current.getMonth()-1); render(); };
    document.getElementById('next').onclick = ()=>{ current.setMonth(current.getMonth()+1); render(); };

    const modal = document.getElementById('modal');
    const mDate = document.getElementById('m-date');
    const mText = document.getElementById('noteText');
    const mMeta = document.getElementById('meta');
    const btnSave = document.getElementById('saveNote');
    const btnDone = document.getElementById('toggleDone');
    document.getElementById('closeModal').onclick = ()=>modal.close();

    let openISO = null;

    function iso(d){ return d.toISOString().slice(0,10); }
    function fmtLong(d){ return d.toLocaleDateString(undefined,{weekday:'short',month:'long',day:'numeric',year:'numeric'}); }
    function daysInMonth(y,m){ return new Date(y,m+1,0).getDate(); }
    function startOffset(y,m){ return new Date(y,m,1).getDay(); }
    function todayISO(){ const t=new Date(); t.setHours(0,0,0,0); return iso(t); }

    function render(){
      monthTitle.textContent = new Date(current).toLocaleDateString(undefined,{month:'short',year:'numeric'}).replace('.', '') ;
      cal.innerHTML = "";
      const y=current.getFullYear(), m=current.getMonth();
      const offset = startOffset(y,m), count = daysInMonth(y,m);

      for(let i=0;i<offset;i++){ const s=document.createElement('div'); s.className='spacerCell'; cal.appendChild(s); }

      const tISO = todayISO();

      for(let d=1; d<=count; d++){
        const dateObj=new Date(y,m,d);
        const dISO=iso(dateObj);
        const btn=document.createElement('button');
        btn.className='day' + (doneMap[dISO]?' done':'') + (dISO===tISO?' today':'');
        btn.setAttribute('aria-label','Open day '+d);
        btn.onclick=()=>openDay(dISO);

        const num=document.createElement('span');
        num.className='num'; num.textContent=d;
        btn.appendChild(num);

        const n=notesMap[dISO];
        if(n && n.text && n.text.trim()!==""){
          btn.classList.add('hasnote');
          const tip=document.createElement('div');
          tip.className='note-tip';
          tip.innerHTML='<div class="title">Note</div>' +
                        '<div class="meta">'+ new Date(n.createdAt).toLocaleString() +'</div>' +
                        '<div style="margin-top:6px;opacity:.9;font-size:.92rem;white-space:pre-wrap;max-height:120px;overflow:auto;">'
                        + escapeHTML(n.text.slice(0,220)) + (n.text.length>220?'…':'') + '</div>';
          btn.appendChild(tip);
        }

        cal.appendChild(btn);
      }

      streakNum.textContent = String(calcStreak());
    }

    function openDay(dISO){
      openISO=dISO;
      const d=new Date(dISO);
      mDate.textContent=fmtLong(d);
      const done=!!doneMap[dISO];
      btnDone.textContent = done? "Unmark Done":"Mark Done";
      const note=notesMap[dISO];
      if(note){ mMeta.textContent="Created: "+ new Date(note.createdAt).toLocaleString(); mText.value=note.text||""; }
      else { mMeta.textContent="No note yet — created when you save."; mText.value=""; }
      modal.showModal();
    }

    btnSave.onclick=()=>{
      if(!openISO) return;
      const ex=notesMap[openISO];
      if(ex){ ex.text=mText.value; }
      else{ notesMap[openISO]={ text:mText.value, createdAt:new Date().toISOString() }; }
      saveJSON(NOTE_KEY, notesMap);
      render();
    };

    btnDone.onclick=()=>{
      if(!openISO) return;
      if(doneMap[openISO]) delete doneMap[openISO]; else doneMap[openISO]=true;
      saveJSON(DONE_KEY, doneMap);
      btnDone.textContent = doneMap[openISO]? "Unmark Done":"Mark Done";
      render();
    };

    function calcStreak(){
      const t=new Date(); t.setHours(0,0,0,0);
      let count=0;
      for(let i=0;i<3650;i++){
        const d=new Date(t); d.setDate(t.getDate()-i);
        const k=iso(d);
        if(doneMap[k]) count++; else break;
      }
      return count;
    }

    function loadJSON(key, fallback){ try{ const v=localStorage.getItem(key); return v? JSON.parse(v):fallback; }catch{return fallback;} }
    function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
    function escapeHTML(str){ return str.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    render();
  </script>
</body>
</html>
